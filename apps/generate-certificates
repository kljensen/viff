#!/usr/bin/make -f

# Copyright 2007 Martin Geisler
#
# This file is part of VIFF
#
# VIFF is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# VIFF is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with VIFF in the file COPYING; if not, write to the Free
# Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
# 02110-1301 USA

# This file is a Makefile which will generate private keys and TLS
# certificates for the players. An extra key and certificate is made
# for signing the other keys.
#
# Each player needs three files to create a TLS connection: the
# certificate (player-X.cert), the private key (player-X.key), and the
# CA certificate (ca.cert).

# TODO: This should probably be rewritten in Python. The optimal
# solution would be a rewrite that uses the Python GNUTLS bindings.

# Default number of players. To generate keys and certificates for,
# say, 5 players, simply add 'N=5' as a command line argument when you
# run the Makefile.
N = 3

PLAYERS = $(addprefix player-, $(shell seq $N))
KEYS = $(addsuffix .key, $(PLAYERS) ca)
CERTS = $(addsuffix .cert, $(PLAYERS) ca)
REQUESTS = $(addsuffix .request, $(PLAYERS) ca)
CFGS = $(addsuffix .cfg, $(PLAYERS) ca)


.PHONY: all
all: $(CERTS)

.PHONY: clean
clean:
	rm -f $(CERTS)
	rm -f $(REQUESTS)
	rm -f $(CFGS)

.PHONY: distclean
distclean: clean
	rm -f $(KEYS)

%.key:
	certtool --generate-privkey --outfile $@

player-%.cfg:
	@echo 'cn = "VIFF Player $*"' > $@
	@echo 'serial = $*' >> $@ # The player number is encoded here.
	@echo 'expiration_days = 365' >> $@
	@echo 'signing_key' >> $@
	@echo 'encryption_key' >> $@

player-%.request: player-%.cfg player-%.key
	certtool --generate-request --template player-$*.cfg \
	 --load-privkey player-$*.key --outfile $@

player-%.cert: player-%.request player-%.cfg ca.cert ca.key
	certtool --generate-certificate --template player-$*.cfg \
	 --load-request player-$*.request \
	 --load-ca-certificate ca.cert --load-ca-privkey ca.key \
	 --outfile $@

ca.cfg:
	@echo 'cn = "VIFF Certificate Authority"' > $@
	@echo 'expiration_days = 365' >> $@
	@echo 'ca' >> $@
	@echo 'cert_signing_key' >> $@


ca.cert: ca.cfg ca.key
	certtool --generate-self-signed --template ca.cfg \
	         --load-privkey ca.key --outfile ca.cert

.INTERMEDIATE: ca.cfg
.PRECIOUS: %.key
